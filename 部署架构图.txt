========================================
   Cloud Run 部署架构 - 已验证成功
========================================

┌─────────────────────────────────────────────────────────────────┐
│                    Google Cloud Platform                        │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Cloud Run Service                           │   │
│  │  ministry-data-cleaning-wu7uk5rgdq-uc.a.run.app         │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────┐        │   │
│  │  │          FastAPI Application                 │        │   │
│  │  │                                              │        │   │
│  │  │  Endpoints:                                  │        │   │
│  │  │  • GET  /health                             │        │   │
│  │  │  • GET  /docs                               │        │   │
│  │  │  • POST /api/v1/clean                       │        │   │
│  │  │  • POST /api/v1/service-layer/generate      │        │   │
│  │  │  • GET  /api/v1/sermon                      │        │   │
│  │  │  • GET  /api/v1/volunteer                   │        │   │
│  │  │  • GET  /api/v1/stats                       │        │   │
│  │  │  • POST /trigger-cleaning (scheduler)       │        │   │
│  │  └─────────────────────────────────────────────┘        │   │
│  │                        │                                 │   │
│  └────────────────────────┼─────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │         Service Layer Manager                          │    │
│  │  • Sermon Domain Transformer                           │    │
│  │  • Volunteer Domain Transformer                        │    │
│  │  • Multi-year generation (2024, 2025, 2026, latest)   │    │
│  └────────────────────────────────────────────────────────┘    │
│                           │                                     │
│                           ▼                                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │         Cloud Storage Integration                      │    │
│  │  gs://grace-irvine-ministry-data/domains/             │    │
│  │                                                         │    │
│  │  ├── sermon/                                           │    │
│  │  │   ├── latest.json                   ✅             │    │
│  │  │   ├── 2024/sermon_2024.json         ✅             │    │
│  │  │   ├── 2025/sermon_2025.json         ✅             │    │
│  │  │   └── 2026/sermon_2026.json         ✅             │    │
│  │  │                                                     │    │
│  │  └── volunteer/                                        │    │
│  │      ├── latest.json                   ✅             │    │
│  │      ├── 2024/volunteer_2024.json      ✅             │    │
│  │      ├── 2025/volunteer_2025.json      ✅             │    │
│  │      └── 2026/volunteer_2026.json      ✅             │    │
│  └────────────────────────────────────────────────────────┘    │
│                           │                                     │
└───────────────────────────┼─────────────────────────────────────┘
                            │
                            ▼
              ┌──────────────────────────┐
              │   Google Sheets API      │
              │  • Source Sheet (read)   │
              │  • Target Sheet (write)  │
              │  • Alias Sheet (read)    │
              └──────────────────────────┘

========================================
        数据流 (Data Flow)
========================================

1. 数据清洗流程:
   Google Sheets (原始数据)
        │
        ▼
   Cloud Run (清洗管线)
        │
        ├──► Google Sheets (清洗后数据)
        │
        └──► logs/clean_preview.json (预览)

2. 服务层生成流程:
   clean_preview.json
        │
        ▼
   Service Layer Manager
        │
        ├──► Sermon Domain Transformer
        │         │
        │         ├──► logs/service_layer/sermon.json (latest)
        │         ├──► logs/service_layer/2024/sermon_2024.json
        │         ├──► logs/service_layer/2025/sermon_2025.json
        │         └──► logs/service_layer/2026/sermon_2026.json
        │
        └──► Volunteer Domain Transformer
                  │
                  ├──► logs/service_layer/volunteer.json (latest)
                  ├──► logs/service_layer/2024/volunteer_2024.json
                  ├──► logs/service_layer/2025/volunteer_2025.json
                  └──► logs/service_layer/2026/volunteer_2026.json

3. Cloud Storage 上传:
   本地 JSON 文件
        │
        ▼
   Cloud Storage Manager
        │
        └──► gs://grace-irvine-ministry-data/domains/
                  ├── sermon/{year}/...
                  └── volunteer/{year}/...

========================================
        验证结果统计
========================================

✅ 部署成功指标:
   • Docker 镜像构建: 成功
   • Cloud Run 部署: 成功
   • 健康检查: 通过
   • 数据清洗: 131 行成功处理
   • 服务层生成: 8 个文件成功生成
   • Cloud Storage: 8 个文件成功上传
   • API 端点: 所有端点正常响应

📊 数据统计:
   年份    Sermon  Volunteer
   ─────────────────────────
   2024    52      52
   2025    52      52
   2026    27      27
   Latest  131     131
   ─────────────────────────
   总计:   262     262

⚡ 性能指标:
   • 数据清洗: ~2 秒
   • 服务层生成: ~2 秒
   • Cloud Storage 上传: ~3 秒
   • API 响应: < 1 秒

========================================
      Quick Commands (快速命令)
========================================

# 健康检查
curl https://ministry-data-cleaning-wu7uk5rgdq-uc.a.run.app/health

# 查看 API 文档
open https://ministry-data-cleaning-wu7uk5rgdq-uc.a.run.app/docs

# 运行完整测试
./test_cloud_run_service_layer.sh

# 查看 Cloud Storage 文件
gcloud storage ls gs://grace-irvine-ministry-data/domains/ --recursive

# 下载证道数据
gcloud storage cat gs://grace-irvine-ministry-data/domains/sermon/latest.json

# 查询 2024 年证道
curl "https://ministry-data-cleaning-wu7uk5rgdq-uc.a.run.app/api/v1/sermon?year=2024&limit=5"

========================================
           部署完成！🎉
========================================

所有服务层功能已在 Cloud Run 上成功部署并验证通过！

